<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rbac.system.mapper.SysDashboardMapper">

    <select id="selectOnlineUsers" resultType="int">
        select count(1) from sys_user where del_flag = '0' and login_date >= now() - interval '5 minutes'
    </select>

    <select id="selectTotalUsers" resultType="int">
        select count(1) from sys_user where del_flag = '0'
    </select>

    <select id="selectTotalRoles" resultType="int">
        select count(1) from sys_role where del_flag = '0'
    </select>

    <select id="selectTotalDepts" resultType="int">
        select count(1) from sys_dept where del_flag = '0'
    </select>

    <select id="selectTotalPosts" resultType="int">
        select count(1) from sys_post where status = '0'
    </select>

    <select id="selectUnseenNotices" resultType="int">
        select count(1) from sys_notice where status = '0'
    </select>

    <select id="selectRoleOverview" resultType="map">
        select r.role_name as role_name, coalesce(count(ur.user_id),0) as cnt
        from sys_role r
        left join sys_user_role ur on r.role_id = ur.role_id
        where r.del_flag = '0'
        group by r.role_name
        order by cnt desc
    </select>

    <select id="selectOperationChart" resultType="map">
        select
            case business_type
                when 1 then 'Add'
                when 2 then 'Update'
                when 3 then 'Delete'
                when 4 then 'Authorize'
                when 5 then 'Export'
                when 6 then 'Import'
                when 7 then 'Force Logout'
                else 'Other'
            end as label,
            count(1) as cnt
        from sys_oper_log
        where oper_time >= now() - interval '7 days'
        group by label
        order by label
    </select>

    <select id="selectTotalLoginLogs" resultType="int">
        select count(1) from sys_logininfor
    </select>

    <select id="selectTotalOperationLogs" resultType="int">
        select count(1) from sys_oper_log
    </select>

    <select id="selectRecentOperationLogs" resultType="map">
        select oper_id, title, oper_name, dept_name, oper_ip, status, oper_time
        from sys_oper_log
        order by oper_time desc
        limit 10
    </select>

    <select id="selectRecentLoginLogs" resultType="map">
        select info_id, user_name, ipaddr, status, msg, login_time
        from sys_logininfor
        order by login_time desc
        limit 10
    </select>

</mapper>
